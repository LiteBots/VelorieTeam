<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Panel – Velorie Style</title>
  <meta name="theme-color" content="#0a1030" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root { --accent:#ff0354; }
    body{
      background-color:#00010f;
      background-image: radial-gradient(1200px 600px at 80% -10%, #0a1030 0%, #050919 35%, #00010f 65%, #000000 100%);
    }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 999px; }
    ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.08); }

    @keyframes particle-animation {
      0%, 100% { transform: translateY(0%) translateX(0%) rotate(0deg); }
      50% { transform: translateY(-10%) translateX(5%) rotate(20deg); }
    }
    .particle { animation-name: particle-animation; animation-timing-function:ease-in-out; animation-iteration-count:infinite; }

    /* smooth */
    .soft-shadow { box-shadow: 0 18px 55px rgba(0,0,0,.45); }
    .tap { transform: translateZ(0); }
    .tap:active { transform: scale(.98); }

    /* kanban drag */
    .dragging { opacity: .55; transform: rotate(-1deg) scale(.99); }
    .dropzone { outline: 2px dashed rgba(255,3,84,.55); outline-offset: 6px; }
  </style>
</head>

<body class="min-h-screen text-white selection:bg-[#ff0354]/40 selection:text-white">
  <div id="particles-container" aria-hidden="true" class="pointer-events-none fixed inset-0 overflow-hidden z-0"></div>

  <!-- LOCKSCREEN -->
  <div id="lockscreen" class="fixed inset-0 z-[80] grid place-items-center p-4">
    <div class="w-full max-w-md rounded-3xl border border-white/10 bg-white/5 backdrop-blur-2xl soft-shadow overflow-hidden">
      <div class="p-6 border-b border-white/10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-11 w-11 rounded-2xl bg-[var(--accent)]/15 grid place-items-center ring-1 ring-white/10">
            <i data-lucide="shield" class="h-5 w-5 text-[var(--accent)]"></i>
          </div>
          <div class="leading-tight">
            <div class="text-lg font-semibold tracking-tight">Team Panel</div>
            <div class="text-xs text-white/60">Szybkie logowanie PIN</div>
          </div>
        </div>
        <span class="text-xs font-semibold rounded-full bg-white/5 px-3 py-1 text-white/70 border border-white/10">MVP</span>
      </div>

      <div class="p-6 space-y-5">
        <div class="rounded-2xl border border-white/10 bg-black/25 p-4">
          <div class="flex items-center justify-between">
            <div class="text-sm text-white/70">Wpisz PIN dostępu</div>
            <button id="pin-clear" class="tap inline-flex items-center gap-2 rounded-lg bg-white/5 px-3 py-2 text-xs font-semibold hover:bg-white/10 transition">
              <i data-lucide="delete" class="h-4 w-4"></i> Wyczyść
            </button>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <div id="pin-dots" class="flex items-center gap-2">
              <span class="h-3 w-3 rounded-full bg-white/15 ring-1 ring-white/10"></span>
              <span class="h-3 w-3 rounded-full bg-white/15 ring-1 ring-white/10"></span>
              <span class="h-3 w-3 rounded-full bg-white/15 ring-1 ring-white/10"></span>
              <span class="h-3 w-3 rounded-full bg-white/15 ring-1 ring-white/10"></span>
              <span class="h-3 w-3 rounded-full bg-white/15 ring-1 ring-white/10"></span>
            </div>
            <div class="ml-auto text-xs text-white/60">PIN: <span class="font-mono">*****</span></div>
          </div>
          <div id="pin-error" class="hidden mt-3 text-sm text-red-300 bg-red-500/10 border border-red-500/20 rounded-xl px-3 py-2">
            Nieprawidłowy PIN.
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <!-- keypad -->
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="1">1</button>
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="2">2</button>
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="3">3</button>
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="4">4</button>
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="5">5</button>
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="6">6</button>
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="7">7</button>
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="8">8</button>
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="9">9</button>
          <button id="pin-back" class="tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-sm flex items-center justify-center gap-2">
            <i data-lucide="undo-2" class="h-4 w-4"></i> Cofnij
          </button>
          <button class="pin-key tap rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 py-4 font-semibold text-lg" data-k="0">0</button>
          <button id="pin-enter" class="tap rounded-2xl border border-[var(--accent)]/30 bg-[var(--accent)]/20 hover:bg-[var(--accent)]/30 py-4 font-semibold text-sm flex items-center justify-center gap-2">
            <i data-lucide="log-in" class="h-4 w-4 text-[var(--accent)]"></i> Wejdź
          </button>
        </div>

        <div class="text-xs text-white/60 leading-relaxed">
          UX założenie: panel ma być szybki. Ten ekran to demo — w produkcji PIN/auth powinny być walidowane po stronie backendu.
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden relative z-10">
    <!-- header -->
    <header class="sticky top-0 z-50 backdrop-blur-xl bg-black/20 border-b border-white/10">
      <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3 flex-shrink-0">
          <div class="h-10 w-10 rounded-xl bg-white/5 ring-1 ring-white/10 grid place-items-center">
            <i data-lucide="layers" class="h-5 w-5 text-[var(--accent)]"></i>
          </div>
          <div class="leading-tight hidden sm:block">
            <div class="text-lg font-semibold tracking-tight">Team Panel</div>
            <div class="text-xs text-white/60">Zlecenia • Projekty • Punkty</div>
          </div>
        </div>

        <div class="flex items-center gap-2 flex-shrink-0">
          <div class="hidden md:flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium border border-white/10">
            <i data-lucide="badge-check" class="h-4 w-4 text-[var(--accent)]"></i>
            <span id="whoami-role">Manager</span>
            <span class="text-white/40">•</span>
            <span id="whoami-name">Klaudia</span>
          </div>

          <div class="hidden sm:flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium border border-white/10">
            <i data-lucide="wallet" class="h-4 w-4 text-[var(--accent)]"></i>
            <span id="header-balance">0 pkt</span>
          </div>

          <button id="btn-quick-task" class="tap inline-flex items-center gap-2 rounded-lg bg-[var(--accent)]/85 text-white px-4 py-2 text-sm font-semibold hover:bg-[var(--accent)] transition shadow-[0_8px_30px_rgba(255,3,84,0.35)]">
            <i data-lucide="plus" class="h-4 w-4"></i>
            <span class="hidden sm:inline">Dodaj zlecenie</span>
          </button>

          <button id="btn-logout" class="tap inline-flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 transition border border-white/10">
            <i data-lucide="log-out" class="h-4 w-4"></i>
            <span class="hidden sm:inline">Wyloguj</span>
          </button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl p-4 md:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <!-- sidebar -->
        <aside class="lg:col-span-1">
          <div class="p-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl sticky top-24">
            <div class="flex items-center gap-3 px-3 py-2 mb-3 rounded-xl bg-black/20 border border-white/10">
              <div class="h-10 w-10 rounded-xl bg-[var(--accent)]/15 ring-1 ring-white/10 grid place-items-center">
                <i data-lucide="sparkles" class="h-5 w-5 text-[var(--accent)]"></i>
              </div>
              <div class="leading-tight">
                <div class="font-semibold">Szybki panel</div>
                <div class="text-xs text-white/60">bez chaosu</div>
              </div>
            </div>

            <nav class="flex flex-col gap-2">
              <button data-view="dashboard" class="nav-btn flex items-center gap-4 px-5 py-4 rounded-lg bg-white/10 font-semibold text-white transition text-base">
                <i data-lucide="layout-dashboard" class="h-6 w-6 text-[var(--accent)]"></i><span>Dashboard</span>
              </button>
              <button data-view="projects" class="nav-btn flex items-center gap-4 px-5 py-4 rounded-lg text-white/70 hover:bg-white/5 hover:text-white transition text-base">
                <i data-lucide="folder-kanban" class="h-6 w-6"></i><span>Projekty</span>
              </button>
              <button data-view="tasks" class="nav-btn flex items-center gap-4 px-5 py-4 rounded-lg text-white/70 hover:bg-white/5 hover:text-white transition text-base">
                <i data-lucide="kanban" class="h-6 w-6"></i><span>Zlecenia</span>
              </button>
              <button data-view="points" class="nav-btn flex items-center gap-4 px-5 py-4 rounded-lg text-white/70 hover:bg-white/5 hover:text-white transition text-base">
                <i data-lucide="wallet" class="h-6 w-6"></i><span>Punkty / Budżet</span>
              </button>
              <button data-view="reports" class="nav-btn flex items-center gap-4 px-5 py-4 rounded-lg text-white/70 hover:bg-white/5 hover:text-white transition text-base">
                <i data-lucide="bar-chart-3" class="h-6 w-6"></i><span>Raporty</span>
              </button>
              <button data-view="settings" class="nav-btn flex items-center gap-4 px-5 py-4 rounded-lg text-white/70 hover:bg-white/5 hover:text-white transition text-base">
                <i data-lucide="settings" class="h-6 w-6"></i><span>Ustawienia</span>
              </button>
            </nav>

            <div class="mt-4 p-4 rounded-2xl border border-white/10 bg-black/20">
              <div class="text-sm font-semibold">Statusy</div>
              <div class="mt-2 flex flex-wrap gap-2 text-xs">
                <span class="px-2 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">Backlog</span>
                <span class="px-2 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">To do</span>
                <span class="px-2 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">In progress</span>
                <span class="px-2 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">Review</span>
                <span class="px-2 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">Done</span>
              </div>
            </div>
          </div>
        </aside>

        <!-- content -->
        <section class="lg:col-span-4 space-y-8">
          <!-- DASHBOARD -->
          <div id="view-dashboard" class="view space-y-8">
            <div>
              <h1 class="text-4xl font-bold">Dashboard</h1>
              <p class="text-lg text-white/60 mt-2">Twoje rzeczy na dziś: terminy, zadania w toku i szybkie akcje.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="p-6 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-white/60">W toku</div>
                  <i data-lucide="activity" class="h-5 w-5 text-[var(--accent)]"></i>
                </div>
                <div id="kpi-inprogress" class="mt-2 text-3xl font-bold">0</div>
                <div class="mt-2 text-sm text-white/60">Zlecenia w statusie In progress / Review</div>
              </div>

              <div class="p-6 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-white/60">Po terminie</div>
                  <i data-lucide="alarm-clock" class="h-5 w-5 text-[var(--accent)]"></i>
                </div>
                <div id="kpi-overdue" class="mt-2 text-3xl font-bold">0</div>
                <div class="mt-2 text-sm text-white/60">Wymagają uwagi / eskalacji</div>
              </div>

              <div class="p-6 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-white/60">Saldo</div>
                  <i data-lucide="wallet" class="h-5 w-5 text-[var(--accent)]"></i>
                </div>
                <div id="kpi-balance" class="mt-2 text-3xl font-bold">0 pkt</div>
                <div class="mt-2 text-sm text-white/60">Punkty (motywacja / rozliczenia)</div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="p-7 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl space-y-4">
                <div class="flex items-center justify-between">
                  <h2 class="text-2xl font-bold">Twoje zadania (szybko)</h2>
                  <button id="btn-jump-kanban" class="tap inline-flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 transition border border-white/10">
                    <i data-lucide="kanban" class="h-4 w-4"></i> Otwórz Kanban
                  </button>
                </div>
                <div id="my-tasks-list" class="space-y-3"></div>
                <div id="my-tasks-empty" class="hidden text-white/60 text-sm rounded-xl border border-white/10 bg-black/20 p-4">
                  Brak zadań przypisanych. Dodaj pierwsze zlecenie i przypisz je do siebie.
                </div>
              </div>

              <div class="p-7 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl space-y-4">
                <div class="flex items-center justify-between">
                  <h2 class="text-2xl font-bold">Powiadomienia</h2>
                  <button id="btn-mark-read" class="tap inline-flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 transition border border-white/10">
                    <i data-lucide="check-check" class="h-4 w-4"></i> Oznacz jako przeczytane
                  </button>
                </div>
                <div id="notif-list" class="space-y-3"></div>
              </div>
            </div>
          </div>

          <!-- PROJECTS -->
          <div id="view-projects" class="view hidden space-y-8">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h1 class="text-4xl font-bold">Projekty</h1>
                <p class="text-lg text-white/60 mt-2">Karta projektu: cele, członkowie, budżet i zdrowie.</p>
              </div>
              <button id="btn-new-project" class="tap inline-flex items-center gap-2 rounded-lg bg-[var(--accent)] px-5 py-3 font-semibold hover:brightness-110 transition shadow-[0_8px_30px_rgba(255,3,84,0.35)]">
                <i data-lucide="plus" class="h-5 w-5"></i><span>Nowy projekt</span>
              </button>
            </div>

            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
          </div>

          <!-- TASKS / KANBAN -->
          <div id="view-tasks" class="view hidden space-y-8">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h1 class="text-4xl font-bold">Zlecenia</h1>
                <p class="text-lg text-white/60 mt-2">Kanban: przeciągnij kartę między statusami. Kliknij kartę, aby wejść w szczegóły.</p>
              </div>
              <div class="flex items-center gap-2">
                <select id="task-filter-project" class="bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition">
                  <option value="all">Wszystkie projekty</option>
                </select>
                <button id="btn-new-task" class="tap inline-flex items-center gap-2 rounded-lg bg-[var(--accent)] px-5 py-3 font-semibold hover:brightness-110 transition shadow-[0_8px_30px_rgba(255,3,84,0.35)]">
                  <i data-lucide="plus" class="h-5 w-5"></i><span>Dodaj</span>
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-5 gap-4 items-start">
              <div class="kan-col p-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl" data-col="Backlog">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Backlog</div>
                  <span class="text-xs text-white/60" data-count="Backlog">0</span>
                </div>
                <div class="mt-3 space-y-3 min-h-[120px]" data-drop="Backlog"></div>
              </div>

              <div class="kan-col p-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl" data-col="To do">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">To do</div>
                  <span class="text-xs text-white/60" data-count="To do">0</span>
                </div>
                <div class="mt-3 space-y-3 min-h-[120px]" data-drop="To do"></div>
              </div>

              <div class="kan-col p-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl" data-col="In progress">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">In progress</div>
                  <span class="text-xs text-white/60" data-count="In progress">0</span>
                </div>
                <div class="mt-3 space-y-3 min-h-[120px]" data-drop="In progress"></div>
              </div>

              <div class="kan-col p-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl" data-col="Review">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Review</div>
                  <span class="text-xs text-white/60" data-count="Review">0</span>
                </div>
                <div class="mt-3 space-y-3 min-h-[120px]" data-drop="Review"></div>
              </div>

              <div class="kan-col p-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl" data-col="Done">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Done</div>
                  <span class="text-xs text-white/60" data-count="Done">0</span>
                </div>
                <div class="mt-3 space-y-3 min-h-[120px]" data-drop="Done"></div>
              </div>
            </div>
          </div>

          <!-- POINTS -->
          <div id="view-points" class="view hidden space-y-8">
            <div>
              <h1 class="text-4xl font-bold">Punkty / Budżet</h1>
              <p class="text-lg text-white/60 mt-2">Tryb MVP: punkty za zadania. Flow: Done → Claim → Approve.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="p-7 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-white/60">Saldo</div>
                  <i data-lucide="wallet" class="h-5 w-5 text-[var(--accent)]"></i>
                </div>
                <div id="points-balance" class="mt-2 text-3xl font-bold">0 pkt</div>
                <div class="mt-2 text-sm text-white/60">Punkty przypisane do użytkownika</div>
              </div>

              <div class="p-7 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl lg:col-span-2">
                <div class="flex items-center justify-between">
                  <h2 class="text-2xl font-bold">Wnioski (Claim)</h2>
                  <span class="text-xs font-semibold rounded-full bg-white/5 px-3 py-1 text-white/70 border border-white/10">Manager akceptuje</span>
                </div>
                <div id="claims-list" class="mt-4 space-y-3"></div>
                <div id="claims-empty" class="hidden mt-4 text-white/60 text-sm rounded-xl border border-white/10 bg-black/20 p-4">
                  Brak wniosków. Oznacz zadanie jako Done i złóż claim.
                </div>
              </div>
            </div>

            <div class="p-7 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
              <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold">Historia transakcji</h2>
                <button id="btn-seed-earn" class="tap inline-flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 transition border border-white/10">
                  <i data-lucide="sparkles" class="h-4 w-4"></i> Dodaj demo wpis
                </button>
              </div>
              <div class="mt-4 overflow-x-auto">
                <table class="w-full text-left">
                  <thead class="border-b border-white/10 text-sm text-white/60">
                    <tr>
                      <th class="p-3">Data</th>
                      <th class="p-3">Typ</th>
                      <th class="p-3">Projekt</th>
                      <th class="p-3">Zlecenie</th>
                      <th class="p-3">Kwota</th>
                      <th class="p-3">Status</th>
                    </tr>
                  </thead>
                  <tbody id="tx-table"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- REPORTS -->
          <div id="view-reports" class="view hidden space-y-8">
            <div>
              <h1 class="text-4xl font-bold">Raporty</h1>
              <p class="text-lg text-white/60 mt-2">Szybkie „zdrowie zespołu”: w toku, po terminie, obciążenie.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="p-6 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
                <div class="text-sm text-white/60">Wszystkie zadania</div>
                <div id="rep-total" class="mt-2 text-3xl font-bold">0</div>
              </div>
              <div class="p-6 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
                <div class="text-sm text-white/60">Średni czas do deadline (demo)</div>
                <div id="rep-avg" class="mt-2 text-3xl font-bold">—</div>
              </div>
              <div class="p-6 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
                <div class="text-sm text-white/60">Punkty (okres)</div>
                <div id="rep-points" class="mt-2 text-3xl font-bold">0 pkt</div>
              </div>
            </div>

            <div class="p-7 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
              <h2 class="text-2xl font-bold">Obciążenie per osoba (demo)</h2>
              <div id="rep-load" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
          </div>

          <!-- SETTINGS -->
          <div id="view-settings" class="view hidden space-y-8">
            <div>
              <h1 class="text-4xl font-bold">Ustawienia</h1>
              <p class="text-lg text-white/60 mt-2">Profil, powiadomienia, role (demo) i preferencje.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="p-7 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl space-y-4">
                <h2 class="text-2xl font-bold">Profil</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm text-white/70 mb-2">Imię</label>
                    <input id="set-name" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition" value="Klaudia"/>
                  </div>
                  <div>
                    <label class="block text-sm text-white/70 mb-2">Rola</label>
                    <select id="set-role" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition">
                      <option>Owner</option>
                      <option selected>Manager</option>
                      <option>Employee</option>
                      <option>Client</option>
                    </select>
                  </div>
                </div>

                <button id="btn-save-profile" class="tap inline-flex items-center justify-center gap-2 w-full rounded-lg bg-[var(--accent)] px-5 py-3 font-semibold hover:brightness-110 transition shadow-[0_8px_30px_rgba(255,3,84,0.35)]">
                  <i data-lucide="save" class="h-5 w-5"></i><span>Zapisz</span>
                </button>

                <div class="text-sm text-white/60">
                  Demo RBAC: UI może pokazywać/ukrywać akcje. Docelowo: uprawnienia per projekt + per funkcja po backendzie.
                </div>
              </div>

              <div class="p-7 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl space-y-4">
                <h2 class="text-2xl font-bold">Powiadomienia</h2>
                <label class="flex items-center justify-between gap-4 p-4 rounded-2xl border border-white/10 bg-black/20">
                  <div>
                    <div class="font-semibold">In-app</div>
                    <div class="text-sm text-white/60">Komentarze, zmiany statusu, terminy</div>
                  </div>
                  <input type="checkbox" checked class="h-5 w-5 accent-[var(--accent)]">
                </label>
                <label class="flex items-center justify-between gap-4 p-4 rounded-2xl border border-white/10 bg-black/20">
                  <div>
                    <div class="font-semibold">Web Push (MVP-lite)</div>
                    <div class="text-sm text-white/60">Tylko do najważniejszych</div>
                  </div>
                  <input type="checkbox" class="h-5 w-5 accent-[var(--accent)]">
                </label>
                <label class="flex items-center justify-between gap-4 p-4 rounded-2xl border border-white/10 bg-black/20">
                  <div>
                    <div class="font-semibold">E-mail</div>
                    <div class="text-sm text-white/60">Raport tygodniowy / przypomnienia</div>
                  </div>
                  <input type="checkbox" class="h-5 w-5 accent-[var(--accent)]">
                </label>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- TASK MODAL -->
  <div id="modal-task" class="hidden fixed inset-0 z-[90]">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="relative mx-auto max-w-2xl p-4 md:p-8">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-2xl soft-shadow overflow-hidden">
        <div class="p-6 border-b border-white/10 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-11 w-11 rounded-2xl bg-[var(--accent)]/15 grid place-items-center ring-1 ring-white/10">
              <i data-lucide="clipboard-list" class="h-5 w-5 text-[var(--accent)]"></i>
            </div>
            <div class="leading-tight">
              <div class="text-lg font-semibold tracking-tight">Nowe zlecenie</div>
              <div class="text-xs text-white/60">Szybkie dodawanie (MVP)</div>
            </div>
          </div>
          <button id="task-close" class="tap inline-flex items-center gap-2 rounded-lg bg-white/5 px-3 py-2 text-xs font-semibold hover:bg-white/10 transition border border-white/10">
            <i data-lucide="x" class="h-4 w-4"></i> Zamknij
          </button>
        </div>

        <div class="p-6 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-white/70 mb-2">Tytuł</label>
              <input id="task-title" placeholder="np. Wdrożenie płatności" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition">
            </div>
            <div>
              <label class="block text-sm text-white/70 mb-2">Projekt</label>
              <select id="task-project" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition"></select>
            </div>
          </div>

          <div>
            <label class="block text-sm text-white/70 mb-2">Opis</label>
            <textarea id="task-desc" rows="3" placeholder="Krótko i konkretnie. Checklistę możesz dopisać w szczegółach." class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition"></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-white/70 mb-2">Priorytet</label>
              <select id="task-priority" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition">
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-white/70 mb-2">Deadline</label>
              <input id="task-deadline" type="date" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition">
            </div>
            <div>
              <label class="block text-sm text-white/70 mb-2">Wartość (pkt)</label>
              <input id="task-points" type="number" min="0" value="5" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-white/70 mb-2">Odpowiedzialny</label>
              <select id="task-assignee" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition"></select>
            </div>
            <div>
              <label class="block text-sm text-white/70 mb-2">Status startowy</label>
              <select id="task-status" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition">
                <option>Backlog</option>
                <option selected>To do</option>
                <option>In progress</option>
                <option>Review</option>
                <option>Done</option>
              </select>
            </div>
          </div>

          <button id="task-save" class="tap w-full inline-flex items-center justify-center gap-2 rounded-lg bg-[var(--accent)] px-5 py-3 font-semibold hover:brightness-110 transition shadow-[0_8px_30px_rgba(255,3,84,0.35)]">
            <i data-lucide="check" class="h-5 w-5"></i><span>Zapisz zlecenie</span>
          </button>

          <div class="text-xs text-white/60">
            Automaty (docelowo): status change → powiadom, przypisz reviewer, ustaw reguły. Tu: demo in-app notyfikacji.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TASK DRAWER -->
  <div id="drawer" class="hidden fixed inset-0 z-[95]">
    <div id="drawer-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-xl border-l border-white/10 bg-white/5 backdrop-blur-2xl soft-shadow overflow-hidden">
      <div class="p-5 border-b border-white/10 flex items-center justify-between gap-3">
        <div class="min-w-0">
          <div class="text-xs text-white/60">Zlecenie</div>
          <div id="d-title" class="text-lg font-semibold truncate">—</div>
        </div>
        <button id="drawer-close" class="tap inline-flex items-center gap-2 rounded-lg bg-white/5 px-3 py-2 text-xs font-semibold hover:bg-white/10 transition border border-white/10">
          <i data-lucide="x" class="h-4 w-4"></i> Zamknij
        </button>
      </div>

      <div class="p-5 space-y-5 overflow-y-auto h-[calc(100%-64px)]">
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
            <div class="text-xs text-white/60">Projekt</div>
            <div id="d-project" class="font-semibold mt-1">—</div>
          </div>
          <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
            <div class="text-xs text-white/60">Odpowiedzialny</div>
            <div id="d-assignee" class="font-semibold mt-1">—</div>
          </div>
          <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
            <div class="text-xs text-white/60">Status</div>
            <select id="d-status" class="mt-1 w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition">
              <option>Backlog</option><option>To do</option><option>In progress</option><option>Review</option><option>Done</option>
            </select>
          </div>
          <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
            <div class="text-xs text-white/60">Deadline</div>
            <div id="d-deadline" class="font-semibold mt-1">—</div>
          </div>
        </div>

        <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Opis</div>
            <span id="d-priority" class="text-xs font-bold px-2 py-1 rounded-full border border-white/10 bg-white/5 text-white/70">—</span>
          </div>
          <div id="d-desc" class="mt-2 text-sm text-white/70 leading-relaxed">—</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
            <div class="text-xs text-white/60">Wartość</div>
            <div class="mt-1 flex items-center gap-2">
              <i data-lucide="wallet" class="h-4 w-4 text-[var(--accent)]"></i>
              <div id="d-points" class="font-semibold">0 pkt</div>
            </div>
          </div>

          <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
            <div class="text-xs text-white/60">Akcje (punkty)</div>
            <button id="btn-claim" class="tap mt-2 w-full inline-flex items-center justify-center gap-2 rounded-lg bg-[var(--accent)]/85 px-4 py-2 text-sm font-semibold hover:bg-[var(--accent)] transition shadow-[0_8px_30px_rgba(255,3,84,0.25)]">
              <i data-lucide="hand-coins" class="h-4 w-4"></i><span>Złóż claim</span>
            </button>
            <div class="mt-2 text-xs text-white/60">Wymaga statusu Done</div>
          </div>
        </div>

        <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Komentarze</div>
            <span class="text-xs text-white/60">@mention działa jako notyfikacja (demo)</span>
          </div>

          <div id="d-comments" class="mt-3 space-y-3"></div>

          <div class="mt-4 grid grid-cols-1 gap-3">
            <textarea id="d-new-comment" rows="2" placeholder="Napisz komentarz… (np. @Klaudia proszę o review)" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition"></textarea>
            <button id="btn-add-comment" class="tap inline-flex items-center justify-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 transition border border-white/10">
              <i data-lucide="send" class="h-4 w-4"></i><span>Dodaj</span>
            </button>
          </div>
        </div>

        <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
          <div class="text-sm font-semibold">Checklist (MVP-lite)</div>
          <div class="mt-3 space-y-2 text-sm text-white/70">
            <label class="flex items-center gap-3">
              <input type="checkbox" class="h-4 w-4 accent-[var(--accent)]"><span>Opis gotowy</span>
            </label>
            <label class="flex items-center gap-3">
              <input type="checkbox" class="h-4 w-4 accent-[var(--accent)]"><span>Weryfikacja / review</span>
            </label>
            <label class="flex items-center gap-3">
              <input type="checkbox" class="h-4 w-4 accent-[var(--accent)]"><span>Zamknięcie / archiwizacja</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TOASTS -->
  <div id="toasts" class="fixed z-[120] right-4 bottom-4 space-y-3"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== particles =====
      const createParticles = () => {
        const container = document.getElementById('particles-container');
        if (!container) return;
        const particleCount = 30;
        for (let i = 0; i < particleCount; i++) {
          const p = document.createElement('span');
          const size = 22 + (i % 6) * 12;
          p.className = 'absolute rounded-full opacity-20 blur-2xl particle';
          p.style.width = `${size}px`;
          p.style.height = `${size}px`;
          p.style.background = i % 3 ? 'var(--accent)' : "#4f46e5";
          p.style.left = `${Math.random() * 100}%`;
          p.style.top = `${Math.random() * 100}%`;
          p.style.animationDuration = `${10 + (i % 6)}s`;
          p.style.animationDelay = `${i * 0.18}s`;
          container.appendChild(p);
        }
      };

      // ===== mini store (demo) =====
      const store = {
        me: { id: 'u1', name: 'Klaudia', role: 'Manager', points: 25 },
        users: [
          { id: 'u1', name: 'Klaudia', role: 'Manager' },
          { id: 'u2', name: 'Olek', role: 'Employee' },
          { id: 'u3', name: 'Maja', role: 'Employee' },
        ],
        projects: [
          { id:'p1', name:'Velorie – Item Shop', desc:'Panel klienta, płatności, UX szybki.', health:'Good', budget: 1200, due:'2026-01-20', members:['u1','u2','u3'] },
          { id:'p2', name:'Automatyzacje', desc:'Reguły: status → notyfikacje, reviewer.', health:'At Risk', budget: 600, due:'2026-02-05', members:['u1','u2'] },
        ],
        tasks: [
          { id:'t1', projectId:'p1', title:'Widok portfela (UI)', desc:'Dopięcie stylu + historia.', status:'Done', priority:'Medium', assigneeId:'u2', reporterId:'u1', deadline:'2025-12-22', points: 8, comments:[
            { id:'c1', authorId:'u1', body:'Zrobimy to szybko i bez chaosu.', at: Date.now()-86400000 }
          ]},
          { id:'t2', projectId:'p1', title:'Zlecenia: Kanban MVP', desc:'Drag&drop + filtr projektu.', status:'In progress', priority:'High', assigneeId:'u1', reporterId:'u1', deadline:'2025-12-24', points: 13, comments:[] },
          { id:'t3', projectId:'p2', title:'Claim → Approve flow', desc:'Done → claim → approve w punktach.', status:'To do', priority:'Medium', assigneeId:'u3', reporterId:'u1', deadline:'2025-12-27', points: 5, comments:[] },
          { id:'t4', projectId:'p2', title:'Powiadomienia in-app', desc:'@mention + zmiana statusu.', status:'Review', priority:'Medium', assigneeId:'u2', reporterId:'u1', deadline:'2025-12-23', points: 7, comments:[] },
        ],
        notifications: [
          { id:'n1', text:'@Klaudia: prośba o review w tasku „Powiadomienia in-app”.', read:false, at: Date.now()-3600000 },
          { id:'n2', text:'Zadanie „Kanban MVP” zmieniono na In progress.', read:false, at: Date.now()-7200000 },
        ],
        claims: [
          { id:'cl1', taskId:'t1', userId:'u2', projectId:'p1', amount:8, status:'pending', createdAt: Date.now()-900000 },
        ],
        tx: [
          { id:'tx1', at: Date.now()-86400000*3, type:'earn', projectId:'p1', taskId:'t1', amount: 8, status:'approved' },
        ]
      };

      // ===== helpers =====
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      const uid = (p='id') => p + Math.random().toString(16).slice(2,10);

      const toast = (msg, kind='info') => {
        const box = document.createElement('div');
        box.className = 'rounded-2xl border border-white/10 bg-white/10 backdrop-blur-xl px-4 py-3 soft-shadow';
        box.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="h-9 w-9 rounded-xl grid place-items-center bg-[var(--accent)]/15 ring-1 ring-white/10">
              <i data-lucide="${kind==='ok'?'check-circle-2':kind==='warn'?'alert-triangle':'bell'}" class="h-5 w-5 text-[var(--accent)]"></i>
            </div>
            <div class="min-w-0">
              <div class="text-sm font-semibold">${kind==='ok'?'Gotowe':kind==='warn'?'Uwaga':'Info'}</div>
              <div class="text-sm text-white/70 mt-1">${msg}</div>
            </div>
          </div>`;
        $('#toasts').appendChild(box);
        lucide.createIcons();
        setTimeout(() => box.remove(), 4200);
      };

      const formatDate = (d) => {
        if (!d) return '—';
        const dt = new Date(d);
        const yyyy = dt.getFullYear();
        const mm = String(dt.getMonth()+1).padStart(2,'0');
        const dd = String(dt.getDate()).padStart(2,'0');
        return `${dd}.${mm}.${yyyy}`;
      };

      const byId = (arr,id) => arr.find(x=>x.id===id);
      const projectName = (pid) => (byId(store.projects,pid)?.name || '—');
      const userName = (uid) => (byId(store.users,uid)?.name || '—');

      // ===== PIN login =====
      const PIN = "33201";
      let pinBuf = "";

      const paintDots = () => {
        const dots = $$('#pin-dots span');
        dots.forEach((dot, i) => {
          dot.className = 'h-3 w-3 rounded-full ring-1 ring-white/10 ' + (i < pinBuf.length ? 'bg-[var(--accent)]' : 'bg-white/15');
        });
      };

      const tryLogin = () => {
        if (pinBuf.length !== PIN.length) return;
        if (pinBuf === PIN) {
          $('#pin-error').classList.add('hidden');
          localStorage.setItem('teamPanelSession', 'ok');
          $('#lockscreen').classList.add('hidden');
          $('#app').classList.remove('hidden');
          toast('Zalogowano. Panel gotowy do pracy.', 'ok');
          renderAll();
          return;
        }
        $('#pin-error').classList.remove('hidden');
        pinBuf = "";
        paintDots();
        toast('Nieprawidłowy PIN.', 'warn');
      };

      $$('.pin-key').forEach(btn => btn.addEventListener('click', () => {
        if (pinBuf.length >= PIN.length) return;
        pinBuf += btn.dataset.k;
        paintDots();
        if (pinBuf.length === PIN.length) tryLogin();
      }));

      $('#pin-back').addEventListener('click', () => { pinBuf = pinBuf.slice(0,-1); paintDots(); $('#pin-error').classList.add('hidden'); });
      $('#pin-clear').addEventListener('click', () => { pinBuf = ""; paintDots(); $('#pin-error').classList.add('hidden'); });
      $('#pin-enter').addEventListener('click', tryLogin);

      // auto session
      if (localStorage.getItem('teamPanelSession') === 'ok') {
        $('#lockscreen').classList.add('hidden');
        $('#app').classList.remove('hidden');
      }

      // ===== navigation =====
      const showView = (name) => {
        $$('.view').forEach(v => v.classList.add('hidden'));
        $('#view-'+name).classList.remove('hidden');
        $$('.nav-btn').forEach(b => {
          const on = b.dataset.view === name;
          b.classList.toggle('bg-white/10', on);
          b.classList.toggle('font-semibold', on);
          b.classList.toggle('text-white', on);
          b.classList.toggle('text-white/70', !on);
          const ico = b.querySelector('i[data-lucide]');
          if (ico) ico.classList.toggle('text-[var(--accent)]', on);
        });
      };
      $$('.nav-btn').forEach(b => b.addEventListener('click', () => showView(b.dataset.view)));
      $('#btn-jump-kanban').addEventListener('click', () => showView('tasks'));

      // ===== header profile =====
      const syncHeader = () => {
        $('#whoami-name').textContent = store.me.name;
        $('#whoami-role').textContent = store.me.role;
        $('#header-balance').textContent = `${store.me.points} pkt`;
        $('#kpi-balance').textContent = `${store.me.points} pkt`;
        $('#points-balance').textContent = `${store.me.points} pkt`;
      };

      // ===== dashboard render =====
      const renderDashboard = () => {
        const now = new Date();
        const overdue = store.tasks.filter(t => t.deadline && new Date(t.deadline) < now && !['Done'].includes(t.status)).length;
        const inprog = store.tasks.filter(t => ['In progress','Review'].includes(t.status)).length;
        $('#kpi-overdue').textContent = overdue;
        $('#kpi-inprogress').textContent = inprog;

        // my tasks
        const mine = store.tasks.filter(t => t.assigneeId === store.me.id && !['Done'].includes(t.status)).slice(0,5);
        const list = $('#my-tasks-list');
        list.innerHTML = '';
        if (!mine.length) $('#my-tasks-empty').classList.remove('hidden'); else $('#my-tasks-empty').classList.add('hidden');

        mine.forEach(t => {
          const el = document.createElement('button');
          el.className = 'tap w-full text-left p-4 rounded-2xl border border-white/10 bg-black/20 hover:bg-black/30 transition';
          el.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold truncate">${t.title}</div>
                <div class="mt-1 text-sm text-white/60 truncate">${projectName(t.projectId)} • ${t.status}</div>
              </div>
              <span class="text-xs font-bold px-2 py-1 rounded-full border border-white/10 bg-white/5 text-white/70">${t.priority}</span>
            </div>
            <div class="mt-3 flex items-center justify-between text-xs text-white/60">
              <span>Deadline: <span class="text-white/80 font-semibold">${t.deadline ? formatDate(t.deadline) : '—'}</span></span>
              <span class="inline-flex items-center gap-2"><i data-lucide="wallet" class="h-4 w-4 text-[var(--accent)]"></i>${t.points} pkt</span>
            </div>
          `;
          el.addEventListener('click', () => openTask(t.id));
          list.appendChild(el);
        });

        // notifications
        const nl = $('#notif-list');
        nl.innerHTML = '';
        store.notifications.slice().sort((a,b)=>b.at-a.at).forEach(n => {
          const el = document.createElement('div');
          el.className = 'p-4 rounded-2xl border border-white/10 ' + (n.read ? 'bg-black/15 text-white/60' : 'bg-black/20');
          el.innerHTML = `
            <div class="flex items-start gap-3">
              <div class="h-9 w-9 rounded-xl grid place-items-center bg-[var(--accent)]/15 ring-1 ring-white/10">
                <i data-lucide="${n.read?'check':'bell'}" class="h-5 w-5 text-[var(--accent)]"></i>
              </div>
              <div class="min-w-0">
                <div class="text-sm ${n.read?'':'font-semibold'}">${n.text}</div>
                <div class="text-xs text-white/50 mt-1">${new Date(n.at).toLocaleString()}</div>
              </div>
            </div>
          `;
          nl.appendChild(el);
        });
      };

      $('#btn-mark-read').addEventListener('click', () => {
        store.notifications.forEach(n => n.read = true);
        toast('Powiadomienia oznaczone jako przeczytane.', 'ok');
        renderDashboard();
        lucide.createIcons();
      });

      // ===== projects render =====
      const renderProjects = () => {
        const grid = $('#projects-grid');
        grid.innerHTML = '';
        store.projects.forEach(p => {
          const el = document.createElement('div');
          el.className = 'p-7 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl';
          const healthColor = p.health === 'Good' ? 'text-green-300 bg-green-500/10 border-green-500/20'
                            : p.health === 'At Risk' ? 'text-yellow-300 bg-yellow-500/10 border-yellow-500/20'
                            : 'text-red-300 bg-red-500/10 border-red-500/20';
          el.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-xl font-bold truncate">${p.name}</div>
                <div class="mt-2 text-sm text-white/70 leading-relaxed">${p.desc}</div>
              </div>
              <span class="text-xs font-bold px-2 py-1 rounded-full border ${healthColor}">${p.health}</span>
            </div>

            <div class="mt-5 grid grid-cols-2 gap-3">
              <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
                <div class="text-xs text-white/60">Termin projektu</div>
                <div class="mt-1 font-semibold">${p.due ? formatDate(p.due) : '—'}</div>
              </div>
              <div class="p-4 rounded-2xl border border-white/10 bg-black/20">
                <div class="text-xs text-white/60">Budżet (demo)</div>
                <div class="mt-1 font-semibold">${p.budget} pkt</div>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              ${p.members.map(id => `<span class="text-xs px-2 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">${userName(id)}</span>`).join('')}
            </div>

            <div class="mt-5 flex items-center justify-between">
              <button class="btn-open-project tap inline-flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 transition border border-white/10" data-p="${p.id}">
                <i data-lucide="kanban" class="h-4 w-4"></i> Kanban
              </button>
              <div class="text-xs text-white/60">${store.tasks.filter(t=>t.projectId===p.id).length} zleceń</div>
            </div>
          `;
          grid.appendChild(el);
        });

        $$('.btn-open-project').forEach(b => b.addEventListener('click', () => {
          $('#task-filter-project').value = b.dataset.p;
          showView('tasks');
          renderKanban();
        }));
      };

      $('#btn-new-project').addEventListener('click', () => {
        const name = prompt('Nazwa projektu (demo):');
        if (!name) return;
        store.projects.unshift({
          id: uid('p'),
          name,
          desc: 'Nowy projekt (demo). Uzupełnij cele i członków w V1.',
          health: 'Good',
          budget: 0,
          due: '',
          members: [store.me.id]
        });
        toast('Projekt utworzony.', 'ok');
        renderProjects();
        fillProjectSelects();
        lucide.createIcons();
      });

      // ===== kanban render + DnD =====
      const statuses = ['Backlog','To do','In progress','Review','Done'];

      const fillProjectSelects = () => {
        const sel = $('#task-project');
        const sel2 = $('#task-filter-project');
        sel.innerHTML = '';
        // filter dropdown
        const keep = sel2.value;
        sel2.innerHTML = `<option value="all">Wszystkie projekty</option>` + store.projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        if (keep) sel2.value = keep;

        store.projects.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          sel.appendChild(opt);
        });

        // assignees
        const as = $('#task-assignee');
        as.innerHTML = store.users.map(u => `<option value="${u.id}">${u.name} (${u.role})</option>`).join('');
        as.value = store.me.id;
      };

      const renderKanban = () => {
        const filter = $('#task-filter-project').value;
        const tasks = filter === 'all' ? store.tasks : store.tasks.filter(t => t.projectId === filter);

        // clear columns
        statuses.forEach(st => {
          const drop = $(`[data-drop="${st}"]`);
          drop.innerHTML = '';
          $(`[data-count="${st}"]`).textContent = tasks.filter(t=>t.status===st).length;
        });

        const prioBadge = (p) => {
          const map = {
            Low: 'bg-white/5 border-white/10 text-white/70',
            Medium: 'bg-white/5 border-white/10 text-white/70',
            High: 'bg-yellow-500/10 border-yellow-500/20 text-yellow-200',
            Critical: 'bg-red-500/10 border-red-500/20 text-red-200',
          };
          return map[p] || map.Medium;
        };

        tasks.forEach(t => {
          const card = document.createElement('div');
          card.className = 'task-card tap p-4 rounded-2xl border border-white/10 bg-black/20 hover:bg-black/30 transition cursor-grab';
          card.draggable = true;
          card.dataset.id = t.id;

          const dd = t.deadline ? new Date(t.deadline) : null;
          const overdue = dd && dd < new Date() && !['Done'].includes(t.status);

          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold leading-snug">${t.title}</div>
                <div class="mt-1 text-xs text-white/60 truncate">${projectName(t.projectId)}</div>
              </div>
              <span class="text-xs font-bold px-2 py-1 rounded-full border ${prioBadge(t.priority)}">${t.priority}</span>
            </div>
            <div class="mt-3 flex items-center justify-between text-xs">
              <span class="inline-flex items-center gap-2 text-white/60">
                <i data-lucide="user" class="h-4 w-4"></i>${userName(t.assigneeId)}
              </span>
              <span class="inline-flex items-center gap-2 ${overdue?'text-red-200':'text-white/60'}">
                <i data-lucide="calendar" class="h-4 w-4"></i>${t.deadline ? formatDate(t.deadline) : '—'}
              </span>
            </div>
            <div class="mt-2 flex items-center justify-between text-xs text-white/60">
              <span class="inline-flex items-center gap-2"><i data-lucide="wallet" class="h-4 w-4 text-[var(--accent)]"></i>${t.points} pkt</span>
              <span class="inline-flex items-center gap-2"><i data-lucide="messages-square" class="h-4 w-4"></i>${t.comments.length}</span>
            </div>
          `;

          card.addEventListener('click', (e) => {
            // prevent click from triggering when dragging ends weirdly
            if (card.classList.contains('dragging')) return;
            openTask(t.id);
          });

          card.addEventListener('dragstart', () => card.classList.add('dragging'));
          card.addEventListener('dragend', () => {
            card.classList.remove('dragging');
            $$('.dropzone').forEach(el => el.classList.remove('dropzone'));
          });

          $(`[data-drop="${t.status}"]`).appendChild(card);
        });

        // drop zones
        $$('[data-drop]').forEach(zone => {
          zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dropzone');
          });
          zone.addEventListener('dragleave', () => zone.classList.remove('dropzone'));
          zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dropzone');
            const dragging = $('.task-card.dragging');
            if (!dragging) return;
            const id = dragging.dataset.id;
            const t = byId(store.tasks, id);
            const newStatus = zone.dataset.drop;
            if (!t) return;
            t.status = newStatus;
            // notify
            store.notifications.unshift({
              id: uid('n'),
              text: `Zadanie „${t.title}” zmieniono na ${newStatus}.`,
              read:false,
              at: Date.now()
            });
            toast(`Status: ${newStatus}`, 'ok');
            renderAll();
          });
        });

        lucide.createIcons();
      };

      $('#task-filter-project').addEventListener('change', renderKanban);

      // ===== task modal =====
      const openTaskModal = () => {
        $('#modal-task').classList.remove('hidden');
        $('#task-title').value = '';
        $('#task-desc').value = '';
        $('#task-priority').value = 'Medium';
        $('#task-status').value = 'To do';
        $('#task-points').value = 5;
        // default date: +3 days
        const d = new Date(Date.now()+86400000*3);
        $('#task-deadline').value = d.toISOString().slice(0,10);
        fillProjectSelects();
        lucide.createIcons();
      };
      const closeTaskModal = () => $('#modal-task').classList.add('hidden');
      $('#btn-new-task').addEventListener('click', openTaskModal);
      $('#btn-quick-task').addEventListener('click', openTaskModal);
      $('#task-close').addEventListener('click', closeTaskModal);
      $('#modal-task').addEventListener('click', (e)=>{ if(e.target=== $('#modal-task').firstElementChild) closeTaskModal(); });

      $('#task-save').addEventListener('click', () => {
        const title = $('#task-title').value.trim();
        if (!title) return toast('Podaj tytuł.', 'warn');
        const t = {
          id: uid('t'),
          projectId: $('#task-project').value,
          title,
          desc: $('#task-desc').value.trim() || '—',
          status: $('#task-status').value,
          priority: $('#task-priority').value,
          assigneeId: $('#task-assignee').value,
          reporterId: store.me.id,
          deadline: $('#task-deadline').value,
          points: Number($('#task-points').value||0),
          comments: []
        };
        store.tasks.unshift(t);
        store.notifications.unshift({
          id: uid('n'),
          text: `Nowe zlecenie „${t.title}” przypisane do ${userName(t.assigneeId)}.`,
          read:false,
          at: Date.now()
        });
        toast('Zlecenie dodane.', 'ok');
        closeTaskModal();
        renderAll();
      });

      // ===== drawer (task details) =====
      let openTaskId = null;

      const openTask = (id) => {
        openTaskId = id;
        const t = byId(store.tasks,id);
        if (!t) return;
        $('#drawer').classList.remove('hidden');
        $('#d-title').textContent = t.title;
        $('#d-project').textContent = projectName(t.projectId);
        $('#d-assignee').textContent = userName(t.assigneeId);
        $('#d-desc').textContent = t.desc;
        $('#d-status').value = t.status;
        $('#d-deadline').textContent = t.deadline ? formatDate(t.deadline) : '—';
        $('#d-priority').textContent = t.priority;
        $('#d-points').textContent = `${t.points} pkt`;
        renderComments(t);
        lucide.createIcons();
      };

      const closeDrawer = () => {
        $('#drawer').classList.add('hidden');
        openTaskId = null;
      };

      $('#drawer-close').addEventListener('click', closeDrawer);
      $('#drawer-backdrop').addEventListener('click', closeDrawer);

      const renderComments = (t) => {
        const box = $('#d-comments');
        box.innerHTML = '';
        if (!t.comments.length) {
          const empty = document.createElement('div');
          empty.className = 'text-sm text-white/60 rounded-xl border border-white/10 bg-black/15 p-4';
          empty.textContent = 'Brak komentarzy. Dodaj krótką informację lub @mention.';
          box.appendChild(empty);
          return;
        }
        t.comments.slice().sort((a,b)=>a.at-b.at).forEach(c => {
          const el = document.createElement('div');
          el.className = 'p-4 rounded-2xl border border-white/10 bg-black/20';
          el.innerHTML = `
            <div class="flex items-center justify-between text-xs text-white/60">
              <span class="font-semibold text-white/80">${userName(c.authorId)}</span>
              <span>${new Date(c.at).toLocaleString()}</span>
            </div>
            <div class="mt-2 text-sm text-white/70 leading-relaxed">${escapeHtml(c.body)}</div>
          `;
          box.appendChild(el);
        });
      };

      const escapeHtml = (str='') => str
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;")
        .replaceAll('\n','<br/>');

      $('#d-status').addEventListener('change', () => {
        if (!openTaskId) return;
        const t = byId(store.tasks, openTaskId);
        if (!t) return;
        t.status = $('#d-status').value;
        store.notifications.unshift({
          id: uid('n'),
          text: `Status „${t.title}” → ${t.status}.`,
          read:false,
          at: Date.now()
        });
        toast('Status zapisany.', 'ok');
        renderAll();
      });

      $('#btn-add-comment').addEventListener('click', () => {
        if (!openTaskId) return;
        const t = byId(store.tasks, openTaskId);
        const body = $('#d-new-comment').value.trim();
        if (!body) return;
        t.comments.push({ id: uid('c'), authorId: store.me.id, body, at: Date.now() });
        $('#d-new-comment').value = '';

        // mention -> notif
        const mention = store.users.find(u => body.includes('@'+u.name));
        if (mention) {
          store.notifications.unshift({
            id: uid('n'),
            text: `@${mention.name}: wspomnienie w „${t.title}”.`,
            read:false,
            at: Date.now()
          });
        }

        toast('Komentarz dodany.', 'ok');
        renderComments(t);
        renderDashboard();
        lucide.createIcons();
      });

      $('#btn-claim').addEventListener('click', () => {
        if (!openTaskId) return;
        const t = byId(store.tasks, openTaskId);
        if (!t) return;
        if (t.status !== 'Done') return toast('Claim możliwy dopiero po ustawieniu statusu Done.', 'warn');

        // avoid duplicates
        const already = store.claims.some(c => c.taskId === t.id && c.status === 'pending');
        if (already) return toast('Claim już istnieje (pending).', 'warn');

        store.claims.unshift({
          id: uid('cl'),
          taskId: t.id,
          userId: t.assigneeId,
          projectId: t.projectId,
          amount: t.points,
          status: 'pending',
          createdAt: Date.now()
        });
        store.notifications.unshift({
          id: uid('n'),
          text: `Nowy claim: ${userName(t.assigneeId)} prosi o ${t.points} pkt za „${t.title}”.`,
          read:false,
          at: Date.now()
        });
        toast('Claim wysłany do akceptacji.', 'ok');
        renderAll();
      });

      // ===== points/claims render =====
      const renderPoints = () => {
        $('#claims-list').innerHTML = '';
        const claims = store.claims.slice().sort((a,b)=>b.createdAt-a.createdAt);
        if (!claims.length) $('#claims-empty').classList.remove('hidden'); else $('#claims-empty').classList.add('hidden');

        claims.forEach(c => {
          const t = byId(store.tasks, c.taskId);
          const p = byId(store.projects, c.projectId);
          const user = byId(store.users, c.userId);
          const el = document.createElement('div');
          el.className = 'p-4 rounded-2xl border border-white/10 bg-black/20';
          const canApprove = ['Owner','Manager'].includes(store.me.role);
          el.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold">${t?.title || '—'}</div>
                <div class="mt-1 text-sm text-white/60 truncate">${p?.name || '—'} • ${user?.name || '—'}</div>
                <div class="mt-2 text-xs text-white/60">Utworzono: ${new Date(c.createdAt).toLocaleString()}</div>
              </div>
              <div class="flex flex-col items-end gap-2">
                <div class="text-sm font-bold inline-flex items-center gap-2">
                  <i data-lucide="wallet" class="h-4 w-4 text-[var(--accent)]"></i> ${c.amount} pkt
                </div>
                <span class="text-xs font-bold px-2 py-1 rounded-full border ${c.status==='pending'?'bg-yellow-500/10 border-yellow-500/20 text-yellow-200':'bg-green-500/10 border-green-500/20 text-green-200'}">
                  ${c.status}
                </span>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              ${canApprove && c.status==='pending' ? `
                <button class="btn-approve tap inline-flex items-center gap-2 rounded-lg bg-[var(--accent)] px-4 py-2 text-sm font-semibold hover:brightness-110 transition shadow-[0_8px_30px_rgba(255,3,84,0.25)]" data-id="${c.id}">
                  <i data-lucide="check" class="h-4 w-4"></i> Zatwierdź
                </button>
                <button class="btn-reject tap inline-flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 transition border border-white/10" data-id="${c.id}">
                  <i data-lucide="x" class="h-4 w-4"></i> Odrzuć
                </button>
              ` : `
                <div class="text-xs text-white/60">Akcja dostępna dla Manager/Owner (RBAC).</div>
              `}
            </div>
          `;
          $('#claims-list').appendChild(el);
        });

        $$('.btn-approve').forEach(b => b.addEventListener('click', () => approveClaim(b.dataset.id)));
        $$('.btn-reject').forEach(b => b.addEventListener('click', () => rejectClaim(b.dataset.id)));

        // tx table
        const tbody = $('#tx-table');
        tbody.innerHTML = '';
        store.tx.slice().sort((a,b)=>b.at-a.at).forEach(x => {
          const row = document.createElement('tr');
          row.className = 'border-b border-white/10';
          const statusPill = x.status==='approved'
            ? `<span class="text-xs font-bold bg-green-500/10 text-green-400 px-2 py-1 rounded-full">approved</span>`
            : `<span class="text-xs font-bold bg-yellow-500/10 text-yellow-400 px-2 py-1 rounded-full">pending</span>`;
          row.innerHTML = `
            <td class="p-3 text-sm text-white/70">${new Date(x.at).toLocaleString()}</td>
            <td class="p-3 text-sm text-white/70">${x.type}</td>
            <td class="p-3 text-sm text-white/70">${projectName(x.projectId)}</td>
            <td class="p-3 text-sm text-white/70">${byId(store.tasks,x.taskId)?.title || '—'}</td>
            <td class="p-3 font-semibold text-white">${x.amount} pkt</td>
            <td class="p-3">${statusPill}</td>
          `;
          tbody.appendChild(row);
        });

        lucide.createIcons();
      };

      const approveClaim = (id) => {
        const c = byId(store.claims, id);
        if (!c || c.status !== 'pending') return;
        c.status = 'approved';

        // add points to user (demo)
        if (c.userId === store.me.id) store.me.points += c.amount;

        store.tx.unshift({
          id: uid('tx'),
          at: Date.now(),
          type: 'earn',
          projectId: c.projectId,
          taskId: c.taskId,
          amount: c.amount,
          status: 'approved'
        });

        store.notifications.unshift({
          id: uid('n'),
          text: `Claim zatwierdzony: ${userName(c.userId)} +${c.amount} pkt.`,
          read:false,
          at: Date.now()
        });

        toast('Claim zatwierdzony.', 'ok');
        renderAll();
      };

      const rejectClaim = (id) => {
        const c = byId(store.claims, id);
        if (!c || c.status !== 'pending') return;
        c.status = 'rejected';
        store.notifications.unshift({
          id: uid('n'),
          text: `Claim odrzucony dla tasku „${byId(store.tasks,c.taskId)?.title || '—'}”.`,
          read:false,
          at: Date.now()
        });
        toast('Claim odrzucony.', 'warn');
        renderAll();
      };

      $('#btn-seed-earn').addEventListener('click', () => {
        store.tx.unshift({
          id: uid('tx'),
          at: Date.now(),
          type: 'adjust',
          projectId: store.projects[0]?.id || 'p1',
          taskId: store.tasks[0]?.id || 't1',
          amount: 3,
          status: 'approved'
        });
        toast('Dodano demo transakcję.', 'ok');
        renderPoints();
      });

      // ===== reports =====
      const renderReports = () => {
        $('#rep-total').textContent = store.tasks.length;
        const now = Date.now();
        const deadlines = store.tasks.filter(t=>t.deadline).map(t => (new Date(t.deadline).getTime() - now)/86400000);
        const avg = deadlines.length ? (deadlines.reduce((a,b)=>a+b,0)/deadlines.length) : null;
        $('#rep-avg').textContent = avg===null ? '—' : `${avg.toFixed(1)} dni`;

        const earned = store.tx.filter(t=>t.type==='earn' && t.status==='approved').reduce((s,x)=>s+x.amount,0);
        $('#rep-points').textContent = `${earned} pkt`;

        // load per user
        const box = $('#rep-load');
        box.innerHTML = '';
        store.users.forEach(u => {
          const inWork = store.tasks.filter(t => t.assigneeId===u.id && !['Done'].includes(t.status)).length;
          const overdue = store.tasks.filter(t => t.assigneeId===u.id && t.deadline && new Date(t.deadline) < new Date() && !['Done'].includes(t.status)).length;
          const el = document.createElement('div');
          el.className = 'p-5 rounded-2xl border border-white/10 bg-black/20';
          el.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-semibold">${u.name}</div>
              <span class="text-xs text-white/60">${u.role}</span>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
              <div class="p-3 rounded-xl border border-white/10 bg-white/5">
                <div class="text-xs text-white/60">W toku</div>
                <div class="mt-1 font-bold">${inWork}</div>
              </div>
              <div class="p-3 rounded-xl border border-white/10 bg-white/5">
                <div class="text-xs text-white/60">Po terminie</div>
                <div class="mt-1 font-bold ${overdue? 'text-red-200':''}">${overdue}</div>
              </div>
            </div>
          `;
          box.appendChild(el);
        });
      };

      // ===== settings =====
      $('#btn-save-profile').addEventListener('click', () => {
        store.me.name = $('#set-name').value.trim() || store.me.name;
        store.me.role = $('#set-role').value;
        toast('Zapisano profil (demo).', 'ok');
        syncHeader();
        renderPoints(); // role affects approve buttons
      });

      // ===== logout =====
      $('#btn-logout').addEventListener('click', () => {
        localStorage.removeItem('teamPanelSession');
        location.reload();
      });

      // ===== render all =====
      const renderAll = () => {
        syncHeader();
        renderDashboard();
        renderProjects();
        fillProjectSelects();
        renderKanban();
        renderPoints();
        renderReports();
        lucide.createIcons();
      };

      // ===== initial =====
      createParticles();
      lucide.createIcons();
      paintDots();

      if (!$('#lockscreen').classList.contains('hidden')) {
        // keep on login
      } else {
        renderAll();
      }
    });
  </script>
</body>
</html>
